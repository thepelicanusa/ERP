from __future__ import annotations
from datetime import date
from sqlalchemy import String, Date, Boolean, JSON, ForeignKey, Index
from sqlalchemy.orm import Mapped, mapped_column, relationship
from app.db.base import Base
from app.db.models.wms.common import HasId, HasCreatedAt

class GLPeriod(Base, HasId, HasCreatedAt):
    __tablename__ = "gl_period"
    period_code: Mapped[str] = mapped_column(String(16), unique=True, nullable=False, index=True)  # e.g. 2026-01
    start_date: Mapped[date] = mapped_column(Date, nullable=False)
    end_date: Mapped[date] = mapped_column(Date, nullable=False)
    is_open: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    meta: Mapped[dict] = mapped_column(JSON, default=dict, nullable=False)

class CurrencyRate(Base, HasId, HasCreatedAt):
    __tablename__ = "fx_rate"
    rate_date: Mapped[date] = mapped_column(Date, nullable=False, index=True)
    base_ccy: Mapped[str] = mapped_column(String(3), default="USD", nullable=False)
    quote_ccy: Mapped[str] = mapped_column(String(3), nullable=False)
    rate: Mapped[float] = mapped_column(String(64), nullable=False)  # store as string to avoid float drift; parse in service
    meta: Mapped[dict] = mapped_column(JSON, default=dict, nullable=False)

Index("ix_fx_rate_date_pair", CurrencyRate.rate_date, CurrencyRate.base_ccy, CurrencyRate.quote_ccy, unique=True)

class TaxCode(Base, HasId, HasCreatedAt):
    __tablename__ = "tax_code"
    code: Mapped[str] = mapped_column(String(32), unique=True, nullable=False, index=True)
    description: Mapped[str | None] = mapped_column(String(256), nullable=True)
    rate: Mapped[float] = mapped_column(String(32), nullable=False)  # string for precision
    input_tax_account_id: Mapped[str | None] = mapped_column(ForeignKey("gl_account.id"), nullable=True, index=True)
    output_tax_account_id: Mapped[str | None] = mapped_column(ForeignKey("gl_account.id"), nullable=True, index=True)
    is_active: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    meta: Mapped[dict] = mapped_column(JSON, default=dict, nullable=False)

    input_tax_account = relationship("app.db.models.accounting.GLAccount", foreign_keys=[input_tax_account_id])
    output_tax_account = relationship("app.db.models.accounting.GLAccount", foreign_keys=[output_tax_account_id])

class SecUserRole(Base, HasId, HasCreatedAt):
    __tablename__ = "sec_user_role"
    username: Mapped[str] = mapped_column(String(128), nullable=False, index=True)
    role: Mapped[str] = mapped_column(String(64), nullable=False, index=True)  # e.g. AP_CLERK, AP_MANAGER, GL_ACCOUNTANT
    scope: Mapped[str] = mapped_column(String(128), default="*", nullable=False)  # company/site scope placeholder
    is_active: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    meta: Mapped[dict] = mapped_column(JSON, default=dict, nullable=False)

Index("ix_sec_user_role_user_role", SecUserRole.username, UserRole.role, unique=True)

class ApprovalRule(Base, HasId, HasCreatedAt):
    __tablename__ = "sec_approval_rule"
    entity_type: Mapped[str] = mapped_column(String(64), nullable=False, index=True)   # e.g. APInvoice
    action: Mapped[str] = mapped_column(String(64), nullable=False, index=True)       # e.g. APPROVE, POST
    required_role: Mapped[str] = mapped_column(String(64), nullable=False)
    no_self_approve: Mapped[bool] = mapped_column(Boolean, default=True, nullable=False)
    meta: Mapped[dict] = mapped_column(JSON, default=dict, nullable=False)

Index("ix_sec_rule_entity_action", ApprovalRule.entity_type, ApprovalRule.action, unique=True)


